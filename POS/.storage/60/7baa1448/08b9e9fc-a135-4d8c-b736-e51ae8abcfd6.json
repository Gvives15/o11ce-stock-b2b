{"tasks": [{"task_id": "1", "dependent_task_ids": [], "instruction": "Implement B0-FE-01 - Vue.js routes with role-based guards. Create a complete Vue.js application with the following requirements:\n\n**Technical Stack:** Vue 3, TypeScript, Vue Router, Pinia, Tailwind CSS\n\n**Tasks to implement:**\n\n1. **Initialize base routes** - Create `src/router/index.ts` with routes: `/pos`, `/history`, `/settings`, `/login`, `/denied`. Use HTML5 history mode. Set redirects: `/` \u2192 `/pos` and `/*` \u2192 `/pos`.\n\n2. **Create auth store (Pinia)** - Create `src/stores/auth.ts` with state: `tokenAccess: string|null`, `roles: string[]`, `profileLoaded: boolean`. Actions: `setToken(token)`, `loadProfile()` (GET `/auth/me`), `logout()`.\n\n3. **Create minimal views** - Create placeholder views: `src/views/PosView.vue`, `HistoryView.vue`, `SettingsView.vue`, `LoginView.vue`, `DeniedView.vue` with simple templates showing titles.\n\n4. **Add route metadata** - In `router/index.ts`, add `meta.requiresAuth` and `meta.roles`:\n   - `/pos`, `/history`: `['vendedor_caja','admin']`\n   - `/settings`: `['admin']`\n   - `/login`, `/denied`: no auth required\n\n5. **Implement global guard (beforeEach)** - Add router guard:\n   - If `!requiresAuth` \u2192 allow\n   - If no `tokenAccess` \u2192 redirect to `/login?redirect=<to>`\n   - If `!profileLoaded` \u2192 `await auth.loadProfile()` (try/catch \u2192 logout and `/login`)\n   - Check `allowedRoles` vs `auth.roles` \u2192 if not allowed, go to `/denied`\n\n6. **Add loader/loading state** - Add NProgress or simple overlay: start in `beforeEach`, finish in `afterEach`. Block render until `profileLoaded`.\n\n7. **Post-login redirection** - In `LoginView.vue`, after `setToken(access)`: read `route.query.redirect || '/pos'` and `router.push` there.\n\n8. **Access denied page** - In `DeniedView.vue`, show 403 message + \"Back\" button (`router.back()` or `router.push('/pos')`).\n\n9. **POS layout** - Create `src/layouts/POSLayout.vue` with simple header and `<router-view/>`. Use it in protected routes.\n\n10. **Basic tests** - Add unit tests for guard logic and basic E2E test for login flow.\n\n11. **Update README** - Document routes, `meta.roles`, how guard works, how to simulate roles.\n\n**Acceptance Criteria:**\n- Without token, protected route \u2192 `/login` with `?redirect`\n- `vendedor_caja` accesses `/pos` and `/history`, NOT `/settings`\n- `admin` accesses all routes\n- Loading state visible while resolving `/auth/me`\n- Clear denied page with exit option\n- No flickering during route transitions\n\n**File Structure:**\n```\nsrc/\n  router/index.ts\n  stores/auth.ts\n  views/\n    PosView.vue\n    HistoryView.vue\n    SettingsView.vue\n    LoginView.vue\n    DeniedView.vue\n  layouts/\n    POSLayout.vue\n```\n\nUse Vue 3 Composition API, TypeScript, and ensure proper error handling for authentication flows.", "task_type": "general", "code": "", "result": "", "is_success": false, "is_finished": true, "assignee": "Alex", "start_at": 1758506236.151208, "end_at": 1758506682.7046332}, {"task_id": "2", "dependent_task_ids": [], "instruction": "Implement B0-FE-02 - Menu and Banners system with role-based navigation and operational state management.\n\n**Tasks to implement:**\n\n1. **Menu model and role mapping** - Create `src/config/menu.ts` exporting MENU_ITEMS with `{id, label, icon, route, roles: string[]}`. Items:\n   - venta (/pos) \u2192 roles ['vendedor_caja','admin']\n   - historial (/history) \u2192 roles ['vendedor_caja','admin'] \n   - config (/settings) \u2192 roles ['admin']\n\n2. **Operations/state store** - Create `src/stores/ops.ts` (Pinia) with state: `hasShiftOpen: boolean`, `hasCashboxOpen: boolean`, `offline: boolean`. Actions: `setShift(open: boolean)`, `setCashbox(open: boolean)`, `setOffline(flag: boolean)`. Listen to window events 'online'/'offline' and update offline state.\n\n3. **Sidebar component with role filtering** - Create `src/components/Sidebar.vue` that:\n   - Imports MENU_ITEMS\n   - Reads roles from useAuth() (Pinia)\n   - Filters MENU_ITEMS by `item.roles.some(r => roles.includes(r))`\n   - Renders list with `<RouterLink>` and Tailwind classes ('active' based on route)\n\n4. **Simple Topbar** - Create `src/components/Topbar.vue` with view title (prop) and status indicator: if offline \u2192 badge 'Offline'; else 'Online'.\n\n5. **Global Banners** - Create `src/components/GlobalBanners.vue` that reads useOps() and shows in severity order:\n   - If offline \u2192 red banner: 'Sin conexi\u00f3n: modo lectura'\n   - Else if !hasShiftOpen \u2192 amber banner: 'No hay turno abierto'\n   - Else if !hasCashboxOpen \u2192 amber banner: 'Caja cerrada'\n\n6. **Integrate components in layout** - Update `src/layouts/POSLayout.vue` to include `<Sidebar/>`, `<Topbar/>` and `<GlobalBanners/>` before `<router-view/>`. Use CSS grid/flex with Tailwind.\n\n7. **Critical action blocking** - Create composable `src/composables/useBlockers.ts` that exposes:\n   - `canCheckout = computed(() => !ops.offline && ops.hasShiftOpen && ops.hasCashboxOpen)`\n   - Helpers for tooltips/messages\n   - Use in PosView.vue to disable \"Cobrar\" button and show reason\n\n8. **Visual styling** - Apply Tailwind:\n   - Sidebar: fixed width, items with hover:bg-muted and aria-current\n   - Banners: red for offline (bg-red-100 text-red-800), amber for shift/cashbox (bg-amber-100 text-amber-800)\n   - Disabled button: opacity-50 cursor-not-allowed\n\n9. **Unit tests** - Add tests:\n   - Sidebar: with roles=['vendedor_caja'] renders 2 items; with ['admin'] renders 3\n   - Blockers: canCheckout is false if offline=true or !hasShiftOpen or !hasCashboxOpen\n\n10. **Online/offline listeners** - In main.ts, when mounting app: `ops.setOffline(!navigator.onLine)`. Add global window listeners to update offline state.\n\n11. **README section** - Update README.md: how to set hasShiftOpen and hasCashboxOpen from future cashbox screens; how to test offline (disconnect network).\n\n**Acceptance Criteria:**\n- Menu shows/hides based on role (vendedor vs admin)\n- Banners appear correctly in severity order: Offline / No shift / Cashbox closed\n- \"Cobrar\" button disables when any critical flag prevents it, with clear message\n- Simple and readable Tailwind styles\n- Offline detection works automatically\n\n**File Structure:**\n```\nsrc/\n  config/menu.ts\n  stores/ops.ts\n  components/\n    Sidebar.vue\n    Topbar.vue\n    GlobalBanners.vue\n  composables/\n    useBlockers.ts\n  layouts/POSLayout.vue (updated)\n  views/PosView.vue (updated)\n```\n\nUse Vue 3 Composition API, TypeScript, and ensure proper integration with existing auth system.", "task_type": "general", "code": "", "result": "", "is_success": false, "is_finished": true, "assignee": "Alex", "start_at": 1758506682.7046413, "end_at": 1758507014.124455}, {"task_id": "3", "dependent_task_ids": [], "instruction": "Implement B0-FE-03 - HTTP Interceptor and Error Handling system with automatic token refresh and user-friendly error management.\n\n**Tasks to implement:**\n\n1. **Create axiosClient** - Create `src/lib/axiosClient.ts` export default axios instance with `baseURL` (from `.env`), `timeout=15000`.\n\n2. **Token utility and store** - In `src/stores/auth.ts`, expose `getAccess()` and `getRefresh()` (if stored), and `setToken(access)`, `setRefresh(refresh?)`, `logout()`.\n\n3. **Request interceptor (Authorization)** - In `axiosClient.ts`, add `axios.interceptors.request.use` that if `auth.getAccess()` exists, add header `Authorization: Bearer <token>`.\n\n4. **Refresh queue (avoid race conditions)** - In `src/lib/authRefresh.ts`, implement:\n   - `let isRefreshing=false; let pendingRequests: ((token:string)=>void)[]=[]`\n   - `enqueue(cb)` and `resolveAll(newToken)`\n   - Export helpers for interceptor use\n\n5. **Response interceptor (401 \u2192 refresh)** - In `axiosClient.ts` `interceptors.response.use`:\n   - If response is 401 and error indicates `token_expired`:\n     - If `!isRefreshing`: set `isRefreshing=true`; `POST /auth/refresh` with `refresh` from store\n     - On success: `auth.setToken(newAccess)`; `resolveAll(newAccess)`; retry original request\n     - On failure: `auth.logout()` and reject\n   - If refresh already in progress: `enqueue(token=> retry original req with new token)`\n\n6. **Error normalizer + toasts** - Create `src/lib/errorToast.ts`:\n   - `mapErrorToMessage(err)` \u2192 short string (e.g., 401 invalid credentials, 403 access denied, 409 conflict, 5xx server error, network: 'No connection')\n   - `showToast(message)` (use existing toast library)\n   - Integrate in `axiosClient` for 4xx/5xx (except refresh flow)\n\n7. **Security safeguards (anti-loops)** - Protect interceptor to **not refresh** if endpoint is already `/auth/refresh` or if original request was already retried (use flag `config.__isRetry=true`). Limit to **1** retry.\n\n8. **Integration with guard (final UX)** - In `router/index.ts` or plugin, if `auth.logout()` is triggered from interceptor, redirect to `/login` and show toast 'Session expired'.\n\n9. **Unit tests for interceptor** - Add tests (Vitest/Jest) for `axiosClient`:\n   - **401 token_expired** \u2192 makes `POST /auth/refresh`, saves `access` and **retries** `/auth/me` (200)\n   - **401 token_expired** with **2+ concurrent requests** \u2192 single refresh, both responses 200\n   - **Invalid refresh** \u2192 `logout()` called and **toast** 'Session expired'\n   - **403** \u2192 shows toast 'Access denied'\n   - **409** \u2192 shows toast 'Conflict/Could not complete action'\n   - **Network Error** \u2192 toast 'No connection'\n\n10. **README \"Interceptor & Errors\"** - Update `README.md` with: refresh flow, how to test expiration (mock 401), toast policy, and how to avoid leaks (don't log tokens).\n\n**Acceptance Criteria:**\n- Requests attach `Authorization` if token exists\n- On **401 due to expiration**, makes **refresh** once and **retries** original request\n- If **refresh fails**, does **logout** and redirects to **/login** with toast \"Session expired\"\n- 4xx/5xx and network errors show **clear toasts**\n- No **refresh loops** or multiple parallel refreshes exist\n\n**File Structure:**\n```\nsrc/\n  lib/\n    axiosClient.ts\n    authRefresh.ts\n    errorToast.ts\n  stores/auth.ts (updated)\n  router/index.ts (updated)\n```\n\n**Environment Variables:**\n- Add `VITE_API_BASE_URL` to `.env` file\n\n**Testing scenarios:**\n1. Login, force `access` expired \u2192 navigate to `/pos` \u2192 stays in view (refresh ok)\n2. Open 2 tabs and trigger fetch simultaneously with expired token \u2192 only 1 refresh\n3. Invalidate `refresh` too \u2192 when navigating, go to `/login` + toast\n4. Simulate 403 and 409 from BE \u2192 appropriate toasts\n\nUse Vue 3 Composition API, TypeScript, and ensure seamless integration with existing auth and routing systems.", "task_type": "general", "code": "", "result": "", "is_success": false, "is_finished": false, "assignee": "Alex", "start_at": 1758507014.1244605}], "current_task_id": "3"}
